configfile: 'config/default.yml'

MEM_PER_GB=1024
ncores = config['ncores']
ml_methods = config['ml_methods']
kfold = config['kfold']

nseeds = config['nseeds']
start_seed = 100
seeds = range(start_seed, start_seed + nseeds)
outcomes = config['outcomes']

include: 'rules/mothur.smk'
include: 'rules/machine-learning.smk'

rule targets:
    input:
        expand('results/predict_{outcome}/{type}_results.csv', outcome = outcomes, type = ['performance', 'feature-importance'])

rule classify_idsa_severity:
    input:
        'code/severity_analysis.R',
        "code/utilities.R",
        "data/process/final_CDI_16S_metadata.tsv",
        "data/raw/max_creat.csv", # TODO: email SET to get these files
        "data/raw/max_wbc.csv",
        "data/raw/r21_fullcohort_edited_deidentified.csv",
        "data/raw/HPI-1878 Lab.csv"
    output:
        csv="data/process/case_idsa_severity.csv",
        png="results/figures/idsa_severe_n.png"
    script:
        'code/severity_analysis.R'

rule prep_idsa_data_for_ml:
    input:
        'workflow/scripts/prep_data_for_ml.R'
    output:
        'data/process/idsa_OTUs.csv'
    resources:
        mem_mb=MEM_PER_GB*8
    script:
        'scripts/prep_data_for_ml.R'

rule prep_severity_data_for_ml:
    input:
        R='workflow/scripts/prep_severity_data_for_ml.R',
        attrib='data/raw/mishare/clinical_outcomes.csv',
        allcause='data/raw/mishare/clinical_outcomes_pt2.csv'
    output:
        attrib='data/process/attrib_OTUs.csv',
        allcause='data/process/allcause_OTUs.csv'
    resources:
        mem_mb=MEM_PER_GB*8
    script:
        'scripts/prep_severity_data_for_ml.R'

rule test_R_code:
    input:
        R='tests/testthat.R',
        scripts=[os.path.join('workflow/rules/scripts', file.strip('test-')) for file in os.listdir('tests/testthat')]
    script:
        '../tests/testthat.R'
