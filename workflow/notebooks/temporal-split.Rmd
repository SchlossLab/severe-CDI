---
title: "Temporal Split"
date: 2022-01-19
output: 
  github_document:
    html_preview: false
---

```{r deps}
library(here)
library(mikropml)
library(rlang)
library(tidyverse)
```

Investigate feasibility of doing a temporal split to train/test models on older data
and then validate on newer data. 
Bootstrap the test data to get empirical 95% CI.

Do the 20% most recent patients have the same proportion of severe cases as the 
other 80% of the patients?

```{r load_data}
metadat_full <- read_csv(here('data','process','cases_full_metadata.csv'))
metadat_int <- read_csv(here('data','process','cases_int_metadata.csv'))
```

```{r functions}
count_prop <- function(dat, colname, part) {
  dat %>% 
    count({{ colname }}) %>% 
    mutate(p = round(n / sum(n), 3)) %>% 
    mutate(partition = part) %>% 
    select(partition, p, {{ colname }}) %>% 
    pivot_wider(names_from = partition, values_from = p)
}
compare_props <- function(test_dat, train_dat, colname) {
  test <- test_dat %>% 
    count_prop({{ colname }}, 'test')
  train <- train_dat %>% 
    count_prop({{ colname }}, 'train')
  full_join(test, train) %>% 
    mutate(severity = paste(quo_name(enquo(colname)), {{ colname }}, sep = "_")
    ) %>% 
    select(severity, train, test)
}
```


```{r int_props}
test_dat_int <- metadat_int %>% 
  arrange(desc(collection_date)) %>% 
  slice_max(order_by = collection_date, prop = 0.2)

train_dat_int <- metadat_int %>% 
  anti_join(test_dat_int)

nrow(test_dat_int)
nrow(train_dat_int)
nrow(metadat_int)

partitions_int <- bind_rows(
  compare_props(test_dat_int, train_dat_int, idsa),
  compare_props(test_dat_int, train_dat_int, attrib),
  compare_props(test_dat_int, train_dat_int, allcause)
) 

kable(partitions_int)
```

